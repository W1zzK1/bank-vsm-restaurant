### Шаг 1: Общая архитектура и принципы работы эквайера

Эквайер — это банк, который обрабатывает платежи по картам от имени магазина (мерчанта). Его основная задача:

1.  Принять запрос на оплату от мерчанта.
    
2.  Проверить данные карты и наличие средств (через платежную систему или напрямую у эмитента).
    
3.  Заблокировать (холд) или сразу списать средства со счета клиента.
    
4.  Вернуть ответ мерчанту об успехе или неудаче операции.
    
5.  В конце дня провести клиринг (обмен финансовой информацией с другими банками) и расчет с мерчантом.
    

**Для вашего API ключевые моменты:**

*   **Идемпотентность:** Все важные эндпоинты (особенно /payments) должны быть идемпотентными. Мерчант может отправить один и тот же запрос дважды из-за сетевых проблем. Повторный запрос с тем же idempotency\_key должен возвращать тот же результат, не создавая дубликата транзакции.
    
*   **Безопасность:** Используйте HTTPS, базовую авторизацию (логин/пароль мерчанта) или JWT-токены для аутентификации запросов.
    
*   **Валидация:** Тщательно проверяйте входящие данные (номера карт, CVV, срок действия, суммы).
    
*   **Статусы операций:** Четкая и predictable система статусов (pending, succeeded, failed, refunded).
    

### Шаг 2: Необходимые эндпоинты API

Вот список эндпоинтов, которые должна реализовывать ваша эмуляция.

#### 1. POST /api/v1/payments — Создание платежа (Основная операция)

Это главный эндпоинт. Мерчант отправляет сюда данные карты для списания средств.

**Запрос (Request):**

json

`   {    "order_id": "order-12345", // Уникальный ID заказа в системе мерчанта    "amount": 10000, // Сумма в минимальных единицах (копейки, центы)    "currency": "RUB", // Валюта (ISO 4217)    "description": "Оплата заказа №order-12345",    "card_data": {      "number": "4242424242424242", // Номер карты      "exp_month": "12", // Месяц окончания срока      "exp_year": "2025", // Год окончания срока      "cvc": "123", // CVV/CVC код      "cardholder": "IVAN IVANOV" // Держатель карты (опционально)    },    "metadata": { // Любые дополнительные данные (опционально)      "client_id": 123,      "user_agent": "Mozilla/5.0..."    },    "ip_address": "192.168.1.1", // IP-адрес плательщика (для 3-D Secure, опционально на этапе эмуляции)    "idempotency_key": "unique_key_12345" // Ключ идемпотентности  }   `

**Логика обработки (ваш бэкенд):**

1.  **Аутентификация:** Проверить логин/пароль мерчанта из заголовков Authorization.
    
2.  **Валидация:** Проверить формат номера карты (алгоритм Луна), срок действия (не просрочена ли), CVC.
    
3.  **Эмуляция ответа банка:**
    
    *   **Успех (например, для карт 4242 4242 4242 4242):** Вернуть статус 200 OK и тело ответа ниже.
        
    *   **Неудача (например, для карт 4000 0000 0000 0002):** Эмулировать отказ. Задать жесткие правила:
        
        *   4000 0000 0000 0002 -> declined (Общий отказ)
            
        *   4000 0000 0000 0069 -> expired\_card (Просроченная карта)
            
        *   4000 0000 0000 0127 -> insufficient\_funds (Недостаточно средств)
            
        *   Любая другая карта -> invalid\_card (Неверный номер)
            
4.  **Создать запись о транзакции** в своем состоянии (БД или in-memory storage).
    

**Ответ (Response) — Успех:**

json

`   {    "id": "pay_123456789", // Уникальный ID платежа в вашей системе    "status": "succeeded", // Статус: "succeeded", "pending", "failed"    "amount": 10000,    "currency": "RUB",    "order_id": "order-12345",    "description": "Оплата заказа №order-12345",    "authorization_details": {      "auth_code": "A1234B", // Код авторизации (эмулируйте рандомную строку)      "rrn": "123456789012" // Retrieval Reference Number (эмулируйте)    },    "created_at": "2023-10-01T12:00:00Z"  }   `

**Ответ — Неудача:**

json

`   {    "id": "pay_987654321",    "status": "failed",    "error": {      "code": "insufficient_funds",      "message": "Недостаточно средств на счете"    },    "created_at": "2023-10-01T12:00:01Z"  }   `

#### 2. GET /api/v1/payments/{paymentId} — Получение информации о платеже

Мерчант использует этот эндпоинт, чтобы проверить статус ранее созданного платежа (например, если упало соединение после отправки POST).

**Ответ:** Аналогичен ответу на POST /payments, но всегда содержит актуальный статус. Если был сделан возврат, статус должен измениться на refunded.

#### 3. POST /api/v1/refunds — Создание возврата

Мерчант инициирует возврат средств на карту клиента.

**Запрос:**

json

`   {    "payment_id": "pay_123456789", // ID оригинального платежа    "amount": 10000, // Можно вернуть не всю сумму (частичный возврат)    "idempotency_key": "refund_key_67890",    "reason": "Возврат товара ненадлежащего качества"  }   `

**Логика обработки:**

1.  Найти платеж по payment\_id.
    
2.  Проверить, что возвращаемая сумма не больше исходной суммы платежа и что ранее не был сделан возврат на большую или равную сумму.
    
3.  Изменить статус оригинального платежа на refunded (или добавить запись о частичном возврате).
    
4.  Вернуть данные о созданном возврате.
    

**Ответ:**

json

`   {    "id": "ref_567890123",    "payment_id": "pay_123456789",    "status": "succeeded",    "amount": 10000,    "currency": "RUB",    "created_at": "2023-10-02T10:00:00Z"  }   `

#### 4. GET /api/v1/refunds/{refundId} — Получение информации о возврате

Аналогично получению платежа.

#### 5. POST /api/v1/webhooks — Управление вебхуками (Очень важный нюанс!)

В реальной жизни банк сам инициирует запросы к мерчанту, чтобы уведомить его об изменении статуса платежа (например, об успешном завершении pending-транзакции). Ваше API должно эмулировать и это.

**Логика:**

1.  Мерчант должен сначала зарегистрировать URL вашего вебхука в вашей системе (это можно сделать через отдельный эндпоинт PUT /api/v1/merchant/webhook\_endpoint или в "настройках мерчанта" в вашем API).
    
2.  При изменении статуса платежа (например, при его создании или после эмуляции 3-D Secure) ваше API должно асинхронно отправить POST-запрос на URL мерчанта.
    
3.  **Тело вебхука** должно содержать все данные о платеже (аналогично ответу GET /payments/{id}).
    
4.  Мерчант должен ответить 200 OK, иначе вы должны повторить запрос через некоторое время (реализуйте простую логику ретраев).
    

**Эндпоинт для настройки URL вебхука (PUT /api/v1/merchant/webhook\_endpoint):**

json

`   {    "url": "https://myshop.com/api/payments/webhook"  }   `